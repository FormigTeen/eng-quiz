version: "3.9"

services:
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    ports:
      - "6379:6379"

  mongodb:
    image: mongo:6
    restart: unless-stopped
    ports:
      - "27017:27017"
    volumes:
      - mongo-data:/data/db

  nats:
    image: nats:2-alpine
    command: [ "-js" ]
    restart: unless-stopped

  gateway:
    build: ./gateway
    env_file: .env
    command: ["npm", "start", "--", "/app/services/*.service.js", "/app/services/**/*.service.js"]
    depends_on:
      - nats
    ports:
      - "3000:3000"
    restart: unless-stopped

  ping:
    build: ./ping
    env_file: .env
    command: ["npm", "start", "--", "/app/services/*.service.js", "/app/services/**/*.service.js"]
    depends_on:
      - nats
    restart: unless-stopped

  pong:
    build: ./pong
    env_file: .env
    command: ["npm", "start", "--", "/app/services/*.service.js", "/app/services/**/*.service.js"]
    depends_on:
      - nats
    restart: unless-stopped

  ws:
    build: ./ws
    env_file: .env
    depends_on:
      - nats
    ports:
      - "8080:8080"
    restart: unless-stopped
    command: ["npm", "start", "--", "/app/services/*.service.js", "/app/services/**/*.service.js"]

  auth:
    build: ./auth
    env_file: .env
    depends_on:
      - nats
      - mongodb
      - redis
    restart: unless-stopped
    command: ["npm", "start", "--", "/app/services/*.service.js", "/app/services/**/*.service.js"]

  content:
    build: ./content
    container_name: content
    restart: unless-stopped
    depends_on:
      - contentdb
    environment:
      NODE_ENV: development
      HOST: 0.0.0.0
      PORT: 1337
      DATABASE_CLIENT: postgres
      DATABASE_HOST: contentdb
      DATABASE_PORT: 5432
      DATABASE_NAME: ${CONTENT_DB_NAME:-strapi}
      DATABASE_USERNAME: ${CONTENT_DB_USER:-strapi}
      DATABASE_PASSWORD: ${CONTENT_DB_PASSWORD:-strapi}
      JWT_SECRET: ${CONTENT_JWT_SECRET:-change-me-jwt}
      ADMIN_JWT_SECRET: ${CONTENT_ADMIN_JWT_SECRET:-change-me-admin-jwt}
      APP_KEYS: ${CONTENT_APP_KEYS:-key1,key2,key3}
    ports:
      - "1337:1337"
    volumes:
      - ./content/config:/opt/app/config
      - ./content/src:/opt/app/src
      - ./content/public/uploads:/opt/app/public/uploads

  contentdb:
    image: postgres:16-alpine
    container_name: contentdb
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${CONTENT_DB_NAME:-strapi}
      POSTGRES_USER: ${CONTENT_DB_USER:-strapi}
      POSTGRES_PASSWORD: ${CONTENT_DB_PASSWORD:-strapi}
    volumes:
      - contentdb-data:/var/lib/postgresql/data

  engine:
    build: ./engine
    env_file: .env
    depends_on:
      - nats
      - redis
    restart: unless-stopped
    command: ["npm", "start", "--", "/app/services/*.service.js", "/app/services/**/*.service.js"]

networks:
  default:
    name: eng-quiz-net

volumes:
  mongo-data:
  contentdb-data:
